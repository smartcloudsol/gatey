import{get as re,post as ie,put as se,del as ae,head as ce,patch as ue}from"aws-amplify/api";import{dispatch as S}from"@wordpress/data";import{Amplify as U}from"aws-amplify";import{fetchAuthSession as E,fetchUserAttributes as Z,fetchMFAPreference as ee,getCurrentUser as te,signOut as x,updateMFAPreference as ne}from"aws-amplify/auth";import{fetchAuthSession as K}from"aws-amplify/auth";import{I18n as C}from"aws-amplify/utils";import{createReduxStore as V,register as z,select as B,dispatch as P,subscribe as j}from"@wordpress/data";import{getConfig as X}from"@smart-cloud/wpsuite-core";var g="gatey_account",W="gatey";var d;typeof WpSuite<"u"?d=WpSuite.siteSettings:d={};var l=e=>{e?.username?window.localStorage.setItem(g,JSON.stringify(e)):window.localStorage.removeItem(g)},c=async e=>{let t=JSON.parse(window.localStorage.getItem(g)??"{}"),n=!1;if(t?.username)try{let o=await K();o?.tokens?.accessToken?.payload?.exp&&o.tokens.accessToken.payload.exp>new Date().getTime()/1e3&&(n=!0)}catch(o){console.error(o)}else try{t=await b(!1),t?.username&&(l(t),t.loaded=!0,n=!0)}catch(o){console.error(o)}return!n&&t?.username&&(l({}),Gatey.cognito.store.then(async o=>{await y(e?.signOutHook),await P(o).clearAccount()})),t},J=async e=>{let t=window.location.hostname.toLowerCase().split(":")[0],n=Gatey.settings?.secondaryUserPoolDomains&&t.toLowerCase().match(Gatey.settings.secondaryUserPoolDomains.toLowerCase())&&Gatey.settings?.userPoolConfigurations.secondary?.Auth?.Cognito?.userPoolId?Gatey.settings?.userPoolConfigurations.secondary:Gatey.settings?.userPoolConfigurations.default,o={Auth:{Cognito:{userPoolClientId:"",userPoolId:"",identityPoolId:"",...n.Auth?.Cognito,loginWith:{oauth:{domain:"",scopes:[],responseType:"code",...n.Auth?.Cognito?.loginWith?.oauth,redirectSignIn:[window.location.origin+Gatey?.settings?.signInPage],redirectSignOut:[window.location.origin+Gatey?.settings?.signInPage]}}}},API:{...n.API,REST:{...n.API?.REST,admin:{endpoint:Gatey.restUrl}}}},r=e?.apiConfigurations?.secondary?.domains&&t.toLowerCase().match(e.apiConfigurations.secondary?.domains.toLowerCase())&&e.apiConfigurations?.secondary?.apis?.length?e.apiConfigurations.secondary:e?.apiConfigurations?.default;r?.apis?.forEach(s=>{let a=o.API?.REST;a&&(a[s.name]={endpoint:s.endpoint,region:s.region})}),f(o,{API:{REST:{headers:async s=>{let a=r?.apis?.find(i=>i.name===s.apiName);if(s.apiName==="admin"||a?.authorization==="ID_TOKEN"||a?.authorization==="ACCESS_TOKEN")try{let i=await u();if(i?.tokens?.idToken&&i?.tokens?.accessToken)return{Authorization:`Bearer ${s.apiName==="admin"||a?.authorization==="ID_TOKEN"?i.tokens.idToken.toString():i.tokens.accessToken.toString()}`}}catch(i){console.error(i),Gatey.cognito.store.then(v=>{P(v).clearAccount()})}return{}}}}})},Y=async()=>{let e=null;return Gatey.settings.customTranslationsUrl&&(e=await fetch(Gatey.settings.customTranslationsUrl+(Gatey.settings.customTranslationsUrl.includes("?")?"&":"?")+"t="+d.lastUpdate).then(t=>t.ok?t.text():null).then(t=>t?JSON.parse(t):null).catch(()=>null)),e??null},q=async()=>{let e=await X("gatey");J(e);let t=window.location.hostname.toLowerCase().split(":")[0],n=e?.apiConfigurations?.secondary?.domains&&t.toLowerCase().match(e.apiConfigurations.secondary?.domains.toLowerCase())&&e.apiConfigurations?.secondary?.apis?.length?e.apiConfigurations.secondary:e?.apiConfigurations?.default,o=await c(n),r=await Y();return{config:e,amplifyConfig:{},account:o,signedIn:!!o?.username&&!o.loaded,nextUrl:void 0,language:void 0,direction:void 0,customTranslations:r,reloadAuthSession:0,reloadUserAttributes:0,reloadMFAPreferences:0}},H={setAmplifyConfig(e){return{type:"SET_AMPLIFY_CONFIG",amplifyConfig:e}},setAccount(e){return{type:"SET_ACCOUNT",account:e}},clearAccount(){return{type:"CLEAR_ACCOUNT"}},setSignedIn(e){return{type:"SET_SIGNED_IN",signedIn:e}},setNextUrl(e){return{type:"SET_NEXT_URL",nextUrl:e}},setLanguage(e){return!e||e==="system"?C.setLanguage(""):C.setLanguage(e),{type:"SET_LANGUAGE",language:e}},setDirection(e){return{type:"SET_DIRECTION",direction:e}},reloadAuthSession(){return{type:"RELOAD_AUTH_SESSION"}},reloadUserAttributes(){return{type:"RELOAD_USER_ATTRIBUTES"}},reloadMFAPreferences(){return{type:"RELOAD_MFA_PREFERENCE"}}},$={getAmplifyConfig(e){return e.amplifyConfig},getAccount(e){return e.account},getNextUrl(e){return e.nextUrl},isSignedIn(e){return e.signedIn},getConfig(e){return e.config},getCustomTranslations(e){return e.customTranslations},getLanguage(e){return e.language},getDirection(e){return e.direction},getState(e){return e}},Q={},T=async()=>{let e=await q(),t=V("wpsuite/gatey",{reducer(n=e,o){switch(o.type){case"SET_AMPLIFY_CONFIG":return{...n,amplifyConfig:o.amplifyConfig};case"SET_ACCOUNT":return l(o.account),{...n,account:o.account};case"CLEAR_ACCOUNT":return l({}),{...n,account:{}};case"RELOAD_AUTH_SESSION":{let r=Math.random();return{...n,reloadAuthSession:n.reloadAuthSession!==r?r:r+1}}case"RELOAD_USER_ATTRIBUTES":{let r=Math.random();return{...n,reloadUserAttributes:n.reloadUserAttributes!==r?r:r+1}}case"RELOAD_MFA_PREFERENCE":{let r=Math.random();return{...n,reloadMFAPreferences:n.reloadMFAPreferences!==r?r:r+1}}case"SET_SIGNED_IN":return{...n,signedIn:o.signedIn};case"SET_NEXT_URL":return{...n,nextUrl:o.nextUrl};case"SET_LANGUAGE":return{...n,language:o.language};case"SET_DIRECTION":return{...n,direction:o.direction}}return n},actions:H,selectors:$,resolvers:Q});return z(t),t},p=(e,t,n)=>{let o;function r(){let s=B(e).getState(),a=t(s);if(a!==o){let i=o;o=a,n(o,i)}}let h=j(r,e);return r(),h};var m=()=>U.getConfig(),f=(e,t)=>{U.configure(e,t)},u=e=>E(e),I=()=>Z(),R=()=>ee(),b=async(e=!0)=>{let t=e?await c():{};if(t?.username)return t;try{if((await E()).tokens)return{username:(await te()).username,userAttributes:await I(),mfaPreferences:await R()}}catch(n){console.error(n);try{await x()}catch{}}return{}},O=async()=>{await ne({totp:"DISABLED"})},w=()=>c().then(e=>e?.username),G=()=>c().then(e=>e?.userAttributes),N=()=>c().then(e=>e?.mfaPreferences),F=()=>c().then(e=>!!e?.username),_=e=>A().then(t=>t?.includes(e)||!1),A=()=>u().then(e=>e.tokens?.idToken?.payload["cognito:groups"]instanceof Array?e.tokens.idToken.payload["cognito:groups"].map(t=>t):[]).catch(e=>{console.error(e)}),L=async()=>u().then(e=>e.tokens?.idToken?.payload["cognito:roles"]instanceof Array?e.tokens.idToken.payload["cognito:roles"].map(t=>t).map(t=>t.substring(t.indexOf("/")+1)):[]).catch(e=>{console.error(e)}),M=async()=>u().then(e=>{if(!e.tokens?.idToken?.payload["cognito:preferred_role"])return;let t=e.tokens.idToken.payload["cognito:preferred_role"];return t.substring(t.indexOf("/")+1)}).catch(e=>{console.error(e)}),k=()=>u().then(e=>e.tokens?.accessToken.payload.scope?.split(" ")??[]).catch(e=>{console.error(e)}),oe=async e=>{let t;return Gatey.settings.integrateWpLogin&&Gatey.restUrl?.startsWith("http")&&(t=await Gatey.cognito.post({apiName:"admin",path:"/login"}).response.then(o=>o.body.json()).then(o=>{if(o instanceof Object&&"redirect"in o)return o?.redirect}).catch(o=>{console.error(o)})),e&&await Gatey.cognito.get({apiName:e.apiName,path:e.path,options:e.options}).response.catch(n=>console.error(n)),Gatey.settings.redirectSignIn??t},y=async e=>{let t;Gatey.settings.integrateWpLogin&&(t=await Gatey.cognito.get({apiName:"admin",path:"/logout"}).response.then(n=>n.body.json()).then(n=>{if(n instanceof Object&&"redirect"in n)return n?.redirect}).catch(n=>{console.error(n)})),e&&await Gatey.cognito.get({apiName:e.apiName,path:e.path,options:e.options}).response.catch(n=>console.error(n));try{await x()}catch{}return Gatey.settings.redirectSignOut??t};var ge=()=>{Gatey.cognito.store.then(e=>{p(e,t=>t.nextUrl,async t=>{t&&window.location.assign(t)}),S(e).clearAccount()})},le=e=>{Gatey.cognito.store.then(t=>{S(t).setLanguage(e??"en")})},pe=e=>{Gatey.cognito.store.then(t=>{S(t).setDirection(e??"auto")})};var D=!!Gatey.cognito?.store,de=Gatey.cognito?.store??T();D||(Gatey.cognito={store:de,observeStore:p,setLanguage:le,setDirection:pe,getAmplifyConfig:m,isAuthenticated:F,isInGroup:_,getUsername:w,getUserAttributes:G,getMfaPreferences:N,clearMfaPreferences:O,getGroups:A,getRoles:L,getPreferredRole:M,getScopes:k,signOut:ge,get:re,post:ie,put:se,del:ae,head:ce,patch:ue});D=!0;export{W as TEXT_DOMAIN,O as clearMfaPreferences,f as configureAmplify,m as getAmplifyConfig,A as getGroups,N as getMfaPreferences,M as getPreferredRole,L as getRoles,k as getScopes,G as getUserAttributes,F as isAuthenticated,_ as isInGroup,u as loadAuthSession,R as loadMFAPreferences,I as loadUserAttributes,oe as login,y as logout,p as observeStore,de as store};
