"use strict";var R=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var le=Object.getOwnPropertyNames;var ge=Object.prototype.hasOwnProperty;var O=(e,t)=>()=>(e&&(t=e(e=0)),t);var Y=(e,t)=>{for(var n in t)R(e,n,{get:t[n],enumerable:!0})},de=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of le(t))!ge.call(e,r)&&r!==n&&R(e,r,{get:()=>t[r],enumerable:!(o=pe(t,r))||o.enumerable});return e};var fe=e=>de(R({},"__esModule",{value:!0}),e);function y(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";return Uint8Array.from(atob(t),n=>n.charCodeAt(0))}var ye,f,W,S=O(()=>{"use strict";ye=async e=>{let t=f("emUgRnVEemN0U1BhUXB3amlxc1h0dm9JQklUbXh5Z2YaSRZeZ2EABH5lZgU=",e),n=Uint8Array.from(atob(t),o=>o.charCodeAt(0));return window.crypto.subtle.importKey("raw",n,{name:"AES-CBC",length:256},!1,["decrypt"])},f=(e,t)=>{let o=Uint8Array.from(atob(e),r=>r.charCodeAt(0)).map((r,p)=>r^t+p&255);return new TextDecoder().decode(o)},W=async(e,t)=>{if(e==="")return Promise.resolve({});try{let[n,o]=e.split(":"),r=await ye(t),p=new Uint8Array(atob(n).split("").map(a=>a.charCodeAt(0))),i=new Uint8Array(atob(o).split("").map(a=>a.charCodeAt(0))),s=await window.crypto.subtle.decrypt({name:"AES-CBC",iv:p},r,i);return JSON.parse(new TextDecoder().decode(s))}catch(n){console.error(n);return}}});var J,j,z=O(()=>{"use strict";S();J=f("bG5hcEtWWCVwehwyLSByLD0bGyU/BX4mDj1mPA9lMysBMTcyLw0NBStaBA==",57),j=f("bg55RnpNRQMuJicFJjM0JwszOQgGASQIIzZrGxo3CBc9OwMuBRYrFFESNg==",57)});var q={};Y(q,{getConfigFromStorage:()=>me});var C,Z,H,me,Q=O(()=>{"use strict";C=require("jose");z();S();me=async()=>{let e=null;if(Gatey.siteSettings.subscriber){let n=await(0,C.importJWK)({kty:"EC",x:Z,y:H,crv:"P-256"},"ES256"),o=new Date().getFullYear(),r=Math.floor((Date.now()-new Date(o,0,1).getTime())/(1e3*60*60*24*7)),p=await fetch(Gatey.uploadUrl+"lic.jws?t="+Gatey.siteSettings.lastUpdate+"&y="+o+"&w="+r).then(i=>i.ok?i.text():null).catch(()=>null);if(p)try{let i=location.hostname.split(":")[0],{payload:s}=await(0,C.jwtVerify)(p,n,{algorithms:["ES256"]});if(s.domain!==i&&s.secondaryDomain!==i)throw new Error("Invalid domain in JWT");let a=s.key.split(":"),x=y(a[0]),se=y(a[1]),_=(await fetch(Gatey.uploadUrl+"config.enc?t="+Gatey.siteSettings.lastUpdate).then(A=>A.ok?A.text():null).catch(()=>null))?.split(":");if(_.length===2){let A=y(_[0]),ae=y(_[1]),ce=await crypto.subtle.importKey("raw",x,{name:"AES-GCM"},!1,["decrypt"]),ue=await crypto.subtle.decrypt({name:"AES-GCM",iv:se},ce,new Uint8Array([...A,...ae]));e=JSON.parse(new TextDecoder().decode(ue)),e.subscriptionType=s.subscriptionType,e.secondaryDomain=s.secondaryDomain,e.subscriptionType!=="PROFESSIONAL"&&e.subscriptionType!=="AGENCY"&&(e.socialProviders=[],e.customProviderName="",e.apiConfigurations={default:{apis:[]}})}}catch(i){console.error(i.message)}}return e??null};Z=J;H=j});var Ue={};Y(Ue,{TEXT_DOMAIN:()=>V,clearMfaPreferences:()=>D,configureAmplify:()=>P,decryptData:()=>W,deobfuscate:()=>f,getAmplifyConfig:()=>E,getGroups:()=>w,getMfaPreferences:()=>k,getPreferredRole:()=>B,getRoles:()=>K,getScopes:()=>X,getUserAttributes:()=>M,isAuthenticated:()=>L,isInGroup:()=>v,loadAuthSession:()=>g,loadMFAPreferences:()=>F,loadUserAttributes:()=>N,login:()=>oe,logout:()=>T,observeStore:()=>m,store:()=>ie});module.exports=fe(Ue);var u=require("aws-amplify/api"),U=require("@wordpress/data");var G=require("aws-amplify"),c=require("aws-amplify/auth");var $=require("aws-amplify/auth"),I=require("aws-amplify/utils"),l=require("@wordpress/data");var h="gatey_account",V="gatey";var b=e=>{e?.username?window.localStorage.setItem(h,JSON.stringify(e)):window.localStorage.removeItem(h)},d=async e=>{let t=JSON.parse(window.localStorage.getItem(h)??"{}"),n=!1;if(t?.username)try{let o=await(0,$.fetchAuthSession)();o?.tokens?.accessToken?.payload?.exp&&o.tokens.accessToken.payload.exp>new Date().getTime()/1e3&&(n=!0)}catch(o){console.error(o)}else try{t=await te(!1),t?.username&&(b(t),t.loaded=!0,n=!0)}catch(o){console.error(o)}return!n&&t?.username&&(b({}),Gatey.cognito.store.then(async o=>{await T(e?.signOutHook),await(0,l.dispatch)(o).clearAccount()})),t},Ae=async e=>{let t=window.location.hostname.toLowerCase().split(":")[0],n=t.toLowerCase()===e?.secondaryDomain?.toLowerCase().trim()&&Gatey.settings?.userPoolConfigurations.secondary?.Auth?.Cognito?.userPoolId?Gatey.settings?.userPoolConfigurations.secondary:Gatey.settings?.userPoolConfigurations.default,o={Auth:{Cognito:{userPoolClientId:"",userPoolId:"",identityPoolId:"",...n.Auth?.Cognito,loginWith:{oauth:{domain:"",scopes:[],responseType:"code",...n.Auth?.Cognito?.loginWith?.oauth,redirectSignIn:[window.location.origin+Gatey?.settings?.signInPage],redirectSignOut:[window.location.origin+Gatey?.settings?.signInPage]}}}},API:{...n.API,REST:{...n.API?.REST,admin:{endpoint:Gatey.restUrl}}}},r=t.toLowerCase()===e?.secondaryDomain?.toLowerCase().trim()&&e.apiConfigurations?.secondary?.apis?.length?e.apiConfigurations.secondary:e?.apiConfigurations?.default;r?.apis?.forEach(i=>{let s=o.API?.REST;s&&(s[i.name]={endpoint:i.endpoint,region:i.region})}),P(o,{API:{REST:{headers:async i=>{let s=r?.apis?.find(a=>a.name===i.apiName);if(i.apiName==="admin"||s?.authorization==="ID_TOKEN"||s?.authorization==="ACCESS_TOKEN")try{let a=await g();if(a?.tokens?.idToken&&a?.tokens?.accessToken)return{Authorization:`Bearer ${i.apiName==="admin"||s?.authorization==="ID_TOKEN"?a.tokens.idToken.toString():a.tokens.accessToken.toString()}`}}catch(a){console.error(a),Gatey.cognito.store.then(x=>{(0,l.dispatch)(x).clearAccount()})}return{}}}}})},he=async()=>{let e=null;return Gatey.settings.customTranslationsUrl&&(e=await fetch(Gatey.settings.customTranslationsUrl+(Gatey.settings.customTranslationsUrl.includes("?")?"&":"?")+"t="+Gatey.siteSettings.lastUpdate).then(t=>t.ok?t.text():null).then(t=>t?JSON.parse(t):null).catch(()=>null)),e??null},Se=async()=>{let t=await(await Promise.resolve().then(()=>(Q(),q))).getConfigFromStorage();Ae(t);let o=window.location.hostname.toLowerCase().split(":")[0]===t?.secondaryDomain?.toLowerCase().trim()&&t.apiConfigurations?.secondary?.apis?.length?t.apiConfigurations.secondary:t?.apiConfigurations?.default,r=await d(o),p=await he();return{config:t,amplifyConfig:{},account:r,signedIn:!!r?.username&&!r.loaded,nextUrl:void 0,language:void 0,direction:void 0,customTranslations:p,reloadAuthSession:0,reloadUserAttributes:0,reloadMFAPreferences:0}},Ce={setAmplifyConfig(e){return{type:"SET_AMPLIFY_CONFIG",amplifyConfig:e}},setAccount(e){return{type:"SET_ACCOUNT",account:e}},clearAccount(){return{type:"CLEAR_ACCOUNT"}},setSignedIn(e){return{type:"SET_SIGNED_IN",signedIn:e}},setNextUrl(e){return{type:"SET_NEXT_URL",nextUrl:e}},setLanguage(e){return!e||e==="system"?I.I18n.setLanguage(""):I.I18n.setLanguage(e),{type:"SET_LANGUAGE",language:e}},setDirection(e){return{type:"SET_DIRECTION",direction:e}},reloadAuthSession(){return{type:"RELOAD_AUTH_SESSION"}},reloadUserAttributes(){return{type:"RELOAD_USER_ATTRIBUTES"}},reloadMFAPreferences(){return{type:"RELOAD_MFA_PREFERENCE"}}},be={getAmplifyConfig(e){return e.amplifyConfig},getAccount(e){return e.account},getNextUrl(e){return e.nextUrl},isSignedIn(e){return e.signedIn},getConfig(e){return e.config},getCustomTranslations(e){return e.customTranslations},getLanguage(e){return e.language},getDirection(e){return e.direction},getState(e){return e}},Pe={},ee=async()=>{let e=await Se(),t=(0,l.createReduxStore)("wpsuite/gatey",{reducer(n=e,o){switch(o.type){case"SET_AMPLIFY_CONFIG":return{...n,amplifyConfig:o.amplifyConfig};case"SET_ACCOUNT":return b(o.account),{...n,account:o.account};case"CLEAR_ACCOUNT":return b({}),{...n,account:{}};case"RELOAD_AUTH_SESSION":{let r=Math.random();return{...n,reloadAuthSession:n.reloadAuthSession!==r?r:r+1}}case"RELOAD_USER_ATTRIBUTES":{let r=Math.random();return{...n,reloadUserAttributes:n.reloadUserAttributes!==r?r:r+1}}case"RELOAD_MFA_PREFERENCE":{let r=Math.random();return{...n,reloadMFAPreferences:n.reloadMFAPreferences!==r?r:r+1}}case"SET_SIGNED_IN":return{...n,signedIn:o.signedIn};case"SET_NEXT_URL":return{...n,nextUrl:o.nextUrl};case"SET_LANGUAGE":return{...n,language:o.language};case"SET_DIRECTION":return{...n,direction:o.direction}}return n},actions:Ce,selectors:be,resolvers:Pe});return(0,l.register)(t),t},m=(e,t,n)=>{let o;function r(){let i=(0,l.select)(e).getState(),s=t(i);if(s!==o){let a=o;o=s,n(o,a)}}let p=(0,l.subscribe)(r,e);return r(),p};var E=()=>G.Amplify.getConfig(),P=(e,t)=>{G.Amplify.configure(e,t)},g=e=>(0,c.fetchAuthSession)(e),N=()=>(0,c.fetchUserAttributes)(),F=()=>(0,c.fetchMFAPreference)(),te=async(e=!0)=>{let t=e?await d():{};if(t?.username)return t;try{if((await(0,c.fetchAuthSession)()).tokens)return{username:(await(0,c.getCurrentUser)()).username,userAttributes:await N(),mfaPreferences:await F()}}catch(n){console.error(n);try{await(0,c.signOut)()}catch{}}return{}},D=async()=>{await(0,c.updateMFAPreference)({totp:"DISABLED"})},ne=()=>d().then(e=>e?.username),M=()=>d().then(e=>e?.userAttributes),k=()=>d().then(e=>e?.mfaPreferences),L=()=>d().then(e=>!!e?.username),v=e=>w().then(t=>t?.includes(e)||!1),w=()=>g().then(e=>e.tokens?.idToken?.payload["cognito:groups"]instanceof Array?e.tokens.idToken.payload["cognito:groups"].map(t=>t):[]).catch(e=>{console.error(e)}),K=async()=>g().then(e=>e.tokens?.idToken?.payload["cognito:roles"]instanceof Array?e.tokens.idToken.payload["cognito:roles"].map(t=>t).map(t=>t.substring(t.indexOf("/")+1)):[]).catch(e=>{console.error(e)}),B=async()=>g().then(e=>{if(!e.tokens?.idToken?.payload["cognito:preferred_role"])return;let t=e.tokens.idToken.payload["cognito:preferred_role"];return t.substring(t.indexOf("/")+1)}).catch(e=>{console.error(e)}),X=()=>g().then(e=>e.tokens?.accessToken.payload.scope?.split(" ")??[]).catch(e=>{console.error(e)}),oe=async e=>{let t;return Gatey.settings.integrateWpLogin&&Gatey.restUrl?.startsWith("http")&&(t=await Gatey.cognito.post({apiName:"admin",path:"/login"}).response.then(o=>o.body.json()).then(o=>{if(o instanceof Object&&"redirect"in o)return o?.redirect}).catch(o=>{console.error(o)})),e&&await Gatey.cognito.get({apiName:e.apiName,path:e.path,options:e.options}).response.catch(n=>console.error(n)),Gatey.settings.redirectSignIn??t},T=async e=>{let t;Gatey.settings.integrateWpLogin&&(t=await Gatey.cognito.get({apiName:"admin",path:"/logout"}).response.then(n=>n.body.json()).then(n=>{if(n instanceof Object&&"redirect"in n)return n?.redirect}).catch(n=>{console.error(n)})),e&&await Gatey.cognito.get({apiName:e.apiName,path:e.path,options:e.options}).response.catch(n=>console.error(n));try{await(0,c.signOut)()}catch{}return Gatey.settings.redirectSignOut??t};S();var Te=()=>{Gatey.cognito.store.then(e=>{m(e,t=>t.nextUrl,async t=>{t&&window.location.assign(t)}),(0,U.dispatch)(e).clearAccount()})},Ee=e=>{Gatey.cognito.store.then(t=>{(0,U.dispatch)(t).setLanguage(e??"en")})},we=e=>{Gatey.cognito.store.then(t=>{(0,U.dispatch)(t).setDirection(e??"auto")})};var re=!!Gatey.cognito?.store,ie=Gatey.cognito?.store??ee();re||(Gatey.cognito={store:ie,observeStore:m,setLanguage:Ee,setDirection:we,getAmplifyConfig:E,isAuthenticated:L,isInGroup:v,getUsername:ne,getUserAttributes:M,getMfaPreferences:k,clearMfaPreferences:D,getGroups:w,getRoles:K,getPreferredRole:B,getScopes:X,signOut:Te,get:u.get,post:u.post,put:u.put,del:u.del,head:u.head,patch:u.patch});re=!0;0&&(module.exports={TEXT_DOMAIN,clearMfaPreferences,configureAmplify,decryptData,deobfuscate,getAmplifyConfig,getGroups,getMfaPreferences,getPreferredRole,getRoles,getScopes,getUserAttributes,isAuthenticated,isInGroup,loadAuthSession,loadMFAPreferences,loadUserAttributes,login,logout,observeStore,store});
