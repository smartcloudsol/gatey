"use strict";var P=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var q=(e,t)=>{for(var n in t)P(e,n,{get:t[n],enumerable:!0})},Q=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Z(t))!H.call(e,r)&&r!==n&&P(e,r,{get:()=>t[r],enumerable:!(o=Y(t,r))||o.enumerable});return e};var $=e=>Q(P({},"__esModule",{value:!0}),e);var ge={};q(ge,{TEXT_DOMAIN:()=>M,clearMfaPreferences:()=>R,configureAmplify:()=>A,decryptData:()=>z,deobfuscate:()=>D,getAmplifyConfig:()=>S,getGroups:()=>C,getMfaPreferences:()=>O,getPreferredRole:()=>_,getRoles:()=>F,getScopes:()=>L,getUserAttributes:()=>I,isAuthenticated:()=>N,isInGroup:()=>G,loadAuthSession:()=>p,loadMFAPreferences:()=>w,loadUserAttributes:()=>E,login:()=>W,logout:()=>h,observeStore:()=>f,store:()=>J});module.exports=$(ge);var a=require("aws-amplify/api"),b=require("@wordpress/data");var x=require("aws-amplify"),s=require("aws-amplify/auth");var k=require("aws-amplify/auth"),T=require("aws-amplify/utils"),g=require("@wordpress/data"),v=require("@smart-cloud/wpsuite-core");var y="gatey_account",M="gatey";var U;typeof WpSuite<"u"?U=WpSuite.siteSettings:U={};var m=e=>{e?.username?window.localStorage.setItem(y,JSON.stringify(e)):window.localStorage.removeItem(y)},l=async e=>{let t=JSON.parse(window.localStorage.getItem(y)??"{}"),n=!1;if(t?.username)try{let o=await(0,k.fetchAuthSession)();o?.tokens?.accessToken?.payload?.exp&&o.tokens.accessToken.payload.exp>new Date().getTime()/1e3&&(n=!0)}catch(o){console.error(o)}else try{t=await K(!1),t?.username&&(m(t),t.loaded=!0,n=!0)}catch(o){console.error(o)}return!n&&t?.username&&(m({}),Gatey.cognito.store.then(async o=>{await h(e?.signOutHook),await(0,g.dispatch)(o).clearAccount()})),t},ee=async e=>{let t=window.location.hostname.toLowerCase().split(":")[0],n=Gatey.settings?.secondaryUserPoolDomains&&t.toLowerCase().match(Gatey.settings.secondaryUserPoolDomains.toLowerCase())&&Gatey.settings?.userPoolConfigurations.secondary?.Auth?.Cognito?.userPoolId?Gatey.settings?.userPoolConfigurations.secondary:Gatey.settings?.userPoolConfigurations.default,o={Auth:{Cognito:{userPoolClientId:"",userPoolId:"",identityPoolId:"",...n.Auth?.Cognito,loginWith:{oauth:{domain:"",scopes:[],responseType:"code",...n.Auth?.Cognito?.loginWith?.oauth,redirectSignIn:[window.location.origin+Gatey?.settings?.signInPage],redirectSignOut:[window.location.origin+Gatey?.settings?.signInPage]}}}},API:{...n.API,REST:{...n.API?.REST,admin:{endpoint:Gatey.restUrl}}}},r=e?.apiConfigurations?.secondary?.domains&&t.toLowerCase().match(e.apiConfigurations.secondary?.domains.toLowerCase())&&e.apiConfigurations?.secondary?.apis?.length?e.apiConfigurations.secondary:e?.apiConfigurations?.default;r?.apis?.forEach(c=>{let u=o.API?.REST;u&&(u[c.name]={endpoint:c.endpoint,region:c.region})}),A(o,{API:{REST:{headers:async c=>{let u=r?.apis?.find(i=>i.name===c.apiName);if(c.apiName==="admin"||u?.authorization==="ID_TOKEN"||u?.authorization==="ACCESS_TOKEN")try{let i=await p();if(i?.tokens?.idToken&&i?.tokens?.accessToken)return{Authorization:`Bearer ${c.apiName==="admin"||u?.authorization==="ID_TOKEN"?i.tokens.idToken.toString():i.tokens.accessToken.toString()}`}}catch(i){console.error(i),Gatey.cognito.store.then(j=>{(0,g.dispatch)(j).clearAccount()})}return{}}}}})},te=async()=>{let e=null;return Gatey.settings.customTranslationsUrl&&(e=await fetch(Gatey.settings.customTranslationsUrl+(Gatey.settings.customTranslationsUrl.includes("?")?"&":"?")+"t="+U.lastUpdate).then(t=>t.ok?t.text():null).then(t=>t?JSON.parse(t):null).catch(()=>null)),e??null},ne=async()=>{let e=await(0,v.getConfig)("gatey");ee(e);let t=window.location.hostname.toLowerCase().split(":")[0],n=e?.apiConfigurations?.secondary?.domains&&t.toLowerCase().match(e.apiConfigurations.secondary?.domains.toLowerCase())&&e.apiConfigurations?.secondary?.apis?.length?e.apiConfigurations.secondary:e?.apiConfigurations?.default,o=await l(n),r=await te();return{config:e,amplifyConfig:{},account:o,signedIn:!!o?.username&&!o.loaded,nextUrl:void 0,language:void 0,direction:void 0,customTranslations:r,reloadAuthSession:0,reloadUserAttributes:0,reloadMFAPreferences:0}},oe={setAmplifyConfig(e){return{type:"SET_AMPLIFY_CONFIG",amplifyConfig:e}},setAccount(e){return{type:"SET_ACCOUNT",account:e}},clearAccount(){return{type:"CLEAR_ACCOUNT"}},setSignedIn(e){return{type:"SET_SIGNED_IN",signedIn:e}},setNextUrl(e){return{type:"SET_NEXT_URL",nextUrl:e}},setLanguage(e){return!e||e==="system"?T.I18n.setLanguage(""):T.I18n.setLanguage(e),{type:"SET_LANGUAGE",language:e}},setDirection(e){return{type:"SET_DIRECTION",direction:e}},reloadAuthSession(){return{type:"RELOAD_AUTH_SESSION"}},reloadUserAttributes(){return{type:"RELOAD_USER_ATTRIBUTES"}},reloadMFAPreferences(){return{type:"RELOAD_MFA_PREFERENCE"}}},re={getAmplifyConfig(e){return e.amplifyConfig},getAccount(e){return e.account},getNextUrl(e){return e.nextUrl},isSignedIn(e){return e.signedIn},getConfig(e){return e.config},getCustomTranslations(e){return e.customTranslations},getLanguage(e){return e.language},getDirection(e){return e.direction},getState(e){return e}},ie={},B=async()=>{let e=await ne(),t=(0,g.createReduxStore)("wpsuite/gatey",{reducer(n=e,o){switch(o.type){case"SET_AMPLIFY_CONFIG":return{...n,amplifyConfig:o.amplifyConfig};case"SET_ACCOUNT":return m(o.account),{...n,account:o.account};case"CLEAR_ACCOUNT":return m({}),{...n,account:{}};case"RELOAD_AUTH_SESSION":{let r=Math.random();return{...n,reloadAuthSession:n.reloadAuthSession!==r?r:r+1}}case"RELOAD_USER_ATTRIBUTES":{let r=Math.random();return{...n,reloadUserAttributes:n.reloadUserAttributes!==r?r:r+1}}case"RELOAD_MFA_PREFERENCE":{let r=Math.random();return{...n,reloadMFAPreferences:n.reloadMFAPreferences!==r?r:r+1}}case"SET_SIGNED_IN":return{...n,signedIn:o.signedIn};case"SET_NEXT_URL":return{...n,nextUrl:o.nextUrl};case"SET_LANGUAGE":return{...n,language:o.language};case"SET_DIRECTION":return{...n,direction:o.direction}}return n},actions:oe,selectors:re,resolvers:ie});return(0,g.register)(t),t},f=(e,t,n)=>{let o;function r(){let c=(0,g.select)(e).getState(),u=t(c);if(u!==o){let i=o;o=u,n(o,i)}}let d=(0,g.subscribe)(r,e);return r(),d};var S=()=>x.Amplify.getConfig(),A=(e,t)=>{x.Amplify.configure(e,t)},p=e=>(0,s.fetchAuthSession)(e),E=()=>(0,s.fetchUserAttributes)(),w=()=>(0,s.fetchMFAPreference)(),K=async(e=!0)=>{let t=e?await l():{};if(t?.username)return t;try{if((await(0,s.fetchAuthSession)()).tokens)return{username:(await(0,s.getCurrentUser)()).username,userAttributes:await E(),mfaPreferences:await w()}}catch(n){console.error(n);try{await(0,s.signOut)()}catch{}}return{}},R=async()=>{await(0,s.updateMFAPreference)({totp:"DISABLED"})},V=()=>l().then(e=>e?.username),I=()=>l().then(e=>e?.userAttributes),O=()=>l().then(e=>e?.mfaPreferences),N=()=>l().then(e=>!!e?.username),G=e=>C().then(t=>t?.includes(e)||!1),C=()=>p().then(e=>e.tokens?.idToken?.payload["cognito:groups"]instanceof Array?e.tokens.idToken.payload["cognito:groups"].map(t=>t):[]).catch(e=>{console.error(e)}),F=async()=>p().then(e=>e.tokens?.idToken?.payload["cognito:roles"]instanceof Array?e.tokens.idToken.payload["cognito:roles"].map(t=>t).map(t=>t.substring(t.indexOf("/")+1)):[]).catch(e=>{console.error(e)}),_=async()=>p().then(e=>{if(!e.tokens?.idToken?.payload["cognito:preferred_role"])return;let t=e.tokens.idToken.payload["cognito:preferred_role"];return t.substring(t.indexOf("/")+1)}).catch(e=>{console.error(e)}),L=()=>p().then(e=>e.tokens?.accessToken.payload.scope?.split(" ")??[]).catch(e=>{console.error(e)}),W=async e=>{let t;return Gatey.settings.integrateWpLogin&&Gatey.restUrl?.startsWith("http")&&(t=await Gatey.cognito.post({apiName:"admin",path:"/login"}).response.then(o=>o.body.json()).then(o=>{if(o instanceof Object&&"redirect"in o)return o?.redirect}).catch(o=>{console.error(o)})),e&&await Gatey.cognito.get({apiName:e.apiName,path:e.path,options:e.options}).response.catch(n=>console.error(n)),Gatey.settings.redirectSignIn??t},h=async e=>{let t;Gatey.settings.integrateWpLogin&&(t=await Gatey.cognito.get({apiName:"admin",path:"/logout"}).response.then(n=>n.body.json()).then(n=>{if(n instanceof Object&&"redirect"in n)return n?.redirect}).catch(n=>{console.error(n)})),e&&await Gatey.cognito.get({apiName:e.apiName,path:e.path,options:e.options}).response.catch(n=>console.error(n));try{await(0,s.signOut)()}catch{}return Gatey.settings.redirectSignOut??t};var se=async e=>{let t=D("emUgRnVEemN0U1BhUXB3amlxc1h0dm9JQklUbXh5Z2YaSRZeZ2EABH5lZgU=",e),n=Uint8Array.from(atob(t),o=>o.charCodeAt(0));return window.crypto.subtle.importKey("raw",n,{name:"AES-CBC",length:256},!1,["decrypt"])},D=(e,t)=>{let o=Uint8Array.from(atob(e),r=>r.charCodeAt(0)).map((r,d)=>r^t+d&255);return new TextDecoder().decode(o)},z=async(e,t)=>{if(e==="")return Promise.resolve({});try{let[n,o]=e.split(":"),r=await se(t),d=new Uint8Array(atob(n).split("").map(i=>i.charCodeAt(0))),c=new Uint8Array(atob(o).split("").map(i=>i.charCodeAt(0))),u=await window.crypto.subtle.decrypt({name:"AES-CBC",iv:d},r,c);return JSON.parse(new TextDecoder().decode(u))}catch(n){console.error(n);return}};var ae=()=>{Gatey.cognito.store.then(e=>{f(e,t=>t.nextUrl,async t=>{t&&window.location.assign(t)}),(0,b.dispatch)(e).clearAccount()})},ce=e=>{Gatey.cognito.store.then(t=>{(0,b.dispatch)(t).setLanguage(e??"en")})},ue=e=>{Gatey.cognito.store.then(t=>{(0,b.dispatch)(t).setDirection(e??"auto")})};var X=!!Gatey.cognito?.store,J=Gatey.cognito?.store??B();X||(Gatey.cognito={store:J,observeStore:f,setLanguage:ce,setDirection:ue,getAmplifyConfig:S,isAuthenticated:N,isInGroup:G,getUsername:V,getUserAttributes:I,getMfaPreferences:O,clearMfaPreferences:R,getGroups:C,getRoles:F,getPreferredRole:_,getScopes:L,signOut:ae,get:a.get,post:a.post,put:a.put,del:a.del,head:a.head,patch:a.patch});X=!0;0&&(module.exports={TEXT_DOMAIN,clearMfaPreferences,configureAmplify,decryptData,deobfuscate,getAmplifyConfig,getGroups,getMfaPreferences,getPreferredRole,getRoles,getScopes,getUserAttributes,isAuthenticated,isInGroup,loadAuthSession,loadMFAPreferences,loadUserAttributes,login,logout,observeStore,store});
